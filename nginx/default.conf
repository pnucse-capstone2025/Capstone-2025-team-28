# =============================
# nginx/default.conf (전체 교체)
# =============================

# --------
# :80 HTTP
# --------
server {
  listen 80;
  server_name _;

  # [ADDED] HTTPS 사용 시 80 -> 443 리다이렉트
  # 필요 없으면 아래 2줄 주석 처리
  return 301 https://$host$request_uri;
}

# ---------
# :443 HTTPS
# ---------
server {
  listen 443 ssl;
  http2 on;
  server_name _;

  # [CHANGED] 실제 인증서 경로 사용 (Let's Encrypt 마운트 전제)
  # 파일 경로는 compose의 letsencrypt 볼륨(/etc/letsencrypt:ro)에 맞춤
  ssl_certificate     /etc/letsencrypt/live/pnuplay.duckdns.org/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/pnuplay.duckdns.org/privkey.pem;

  # 정적 루트
  root /usr/share/nginx/html;
  index index.html;

  # [ADDED] CORS/Range 헤더 (필요 시 유지)
  add_header Access-Control-Allow-Origin *;
  add_header Access-Control-Expose-Headers "Content-Length,Content-Range";
  add_header Access-Control-Allow-Headers "Range,Origin,Accept,Content-Type";
  add_header Access-Control-Allow-Methods "GET,HEAD,OPTIONS";
  if ($request_method = OPTIONS) { return 204; }

  # [ADDED] SPA 라우팅
  location / {
    try_files $uri /index.html;
  }

  # [ADDED] index.html 은 항상 최신
  location = /index.html {
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
  }

  # [ADDED] 정적 리소스는 강 캐시 (파일명에 해시가 붙으므로 안전)
  location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # [KEEP/CHANGED] DASH 세그먼트/MPD 서빙 (백엔드 생성 파일을 호스트에서 마운트)
  location /stream/ {
    # [ADDED] 짧은 캐시 (원하면 늘려도 됨)
    add_header Cache-Control "public, max-age=300";

    types {
      application/dash+xml           mpd;
      application/octet-stream       m4s;
      video/mp4                      mp4;
      application/x-mpegURL          m3u8;   # [KEEP] 필요 시 유지
      video/mp2t                     ts;
    }
    default_type application/octet-stream;

    # [KEEP] compose 에서 ./server/static -> /srv/stream:ro 로 마운트
    alias /srv/stream/;

    expires 1h;
    autoindex on;   # 디렉토리 listing 필요 없으면 off
  }

  # [KEEP/CHANGED] 백엔드 프록시 (서비스명 backend:8000 으로 고정)
  location /api/ {
    proxy_pass http://backend:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # [ADDED] throttle-sw.js 는 캐시 금지
  location = /throttle-sw.js {
    root /usr/share/nginx/html;
    add_header Cache-Control "no-cache";
  }
}
